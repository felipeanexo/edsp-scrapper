<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard EDSP - Análise Comparativa das Escolas de São Paulo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            opacity: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 1;
        }

        .controls-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .control-group select, .control-group input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group select:focus, .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: #764ba2;
        }

        .comparison-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .comparison-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .comparison-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 300px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .chart-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background: #f8f9fa;
            color: #333;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
        }

        .chart-wrapper {
            position: relative;
            height: 220px;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .table-search {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            width: 200px;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: #666;
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
            font-size: 0.9rem;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e1e5e9;
            background: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .pagination button:hover {
            background: #667eea;
            color: white;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .footer {
            text-align: center;
            color: white;
            padding: 30px 0;
            opacity: 1;
        }

        .footer p {
            margin-bottom: 15px;
            opacity: 1;
        }

        .footer a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
            opacity: 1;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .ideb-high { color: #28a745; font-weight: 600; }
        .ideb-medium { color: #ffc107; font-weight: 600; }
        .ideb-low { color: #dc3545; font-weight: 600; }

        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                height: 250px;
            }
            
            .chart-wrapper {
                height: 170px;
            }
            
            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-search"></i> Análise Comparativa EDSP</h1>
            <p>Encontre a instituição ideal para suas necessidades</p>
        </div>

        <div class="controls-panel">
            <div class="controls-grid">
                <div class="control-group">
                    <label><i class="fas fa-filter"></i> Diretoria de Ensino</label>
                    <select id="directorateFilter">
                        <option value="">Todas as Diretorias</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label><i class="fas fa-graduation-cap"></i> Classificação</label>
                    <select id="classificationFilter">
                        <option value="">Todas as Classificações</option>
                        <option value="PEI">PEI</option>
                        <option value="EE">EE</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label><i class="fas fa-star"></i> IDEB Mínimo</label>
                    <input type="number" id="idebMinFilter" placeholder="Ex: 5.0" step="0.1" min="0" max="10">
                </div>
                
                <div class="control-group">
                    <label><i class="fas fa-users"></i> Alunos Mínimo</label>
                    <input type="number" id="studentsMinFilter" placeholder="Ex: 500" min="0">
                </div>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Todas as Escolas</button>
                <button class="filter-btn" data-filter="top-ideb">Top IDEB</button>
                <button class="filter-btn" data-filter="large-schools">Escolas Grandes</button>
                <button class="filter-btn" data-filter="pei-only">Apenas PEI</button>
                <button class="filter-btn" data-filter="ee-only">Apenas EE</button>
                <button class="filter-btn" data-filter="high-performance">Alto Desempenho</button>
            </div>
        </div>

        <div class="comparison-panel">
            <div class="comparison-header">
                <div class="comparison-title">
                    <i class="fas fa-chart-line"></i> Análise Comparativa
                </div>
                <div class="comparison-actions">
                    <button class="action-btn" onclick="exportData()">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button class="action-btn" onclick="reloadData()">
                        <i class="fas fa-sync"></i> Recarregar
                    </button>
                </div>
            </div>
            
            <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px; color: #667eea;">
                <i class="fas fa-spinner fa-spin"></i> Carregando dados das escolas...
            </div>
            
            <div class="comparison-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalSchools">0</div>
                    <div class="stat-label">Escolas Encontradas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgIdeb">0.0</div>
                    <div class="stat-label">IDEB Médio</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxIdeb">0.0</div>
                    <div class="stat-label">IDEB Máximo</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">Total de Alunos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dataStatus">❌</div>
                    <div class="stat-label">Status dos Dados</div>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-chart-bar"></i> Distribuição IDEB
                    </div>
                    <div class="chart-actions">
                        <button class="action-btn" onclick="exportChart('idebChart')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="idebChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-chart-pie"></i> Classificação por Tipo
                    </div>
                    <div class="chart-actions">
                        <button class="action-btn" onclick="exportChart('classificationChart')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="classificationChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-table"></i> Comparação Detalhada das Escolas
                </div>
                <div class="table-controls">
                    <input type="text" class="table-search" placeholder="Buscar escolas..." id="tableSearch">
                    <div class="pagination-info" id="paginationInfo">
                        Mostrando 1-20 de 0 escolas
                    </div>
                </div>
            </div>
            <div class="table-container">
                <table id="schoolsTable">
                    <thead>
                        <tr>
                            <th>Escola</th>
                            <th>Classificação</th>
                            <th>Diretoria</th>
                            <th>Município</th>
                            <th>IDEB Anos Finais</th>
                            <th>IDEB Ensino Médio</th>
                            <th>Total Alunos</th>
                            <th>Total Turmas</th>
                            <th>Salas de Aula</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dados serão inseridos via JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination">
                <!-- Paginação será inserida via JavaScript -->
            </div>
        </div>

        <div class="footer">
            <p>© 2025 Dashboard EDSP - Desenvolvido com ❤️ por <strong>Felipe Anexo</strong> para a educação de São Paulo</p>
            <div style="margin-top: 10px;">
                <a href="https://github.com/felipeanexo" target="_blank" style="color: white; text-decoration: none; margin: 0 10px;">🐙 GitHub</a>
                <a href="https://linkedin.com/in/felipeversiane" target="_blank" style="color: white; text-decoration: none; margin: 0 10px;">💼 LinkedIn</a>
            </div>
        </div>
    </div>

    <script>
        // Dados reais das escolas (serão carregados do CSV)
        let allSchools = [];
        let filteredSchools = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let charts = {};

        // Carregar dados do CSV
        async function loadSchoolData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            try {
                console.log('Iniciando carregamento dos dados...');
                
                // Tentar diferentes caminhos para o CSV
                const csvPaths = [
                    'results/edsp_schools_20250730_110927.csv',
                    './results/edsp_schools_20250730_110927.csv',
                    '../results/edsp_schools_20250730_110927.csv',
                    'edsp_schools_20250730_110927.csv'
                ];
                
                let response = null;
                let csvPath = '';
                
                for (const path of csvPaths) {
                    try {
                        console.log(`Tentando carregar: ${path}`);
                        response = await fetch(path);
                        if (response.ok) {
                            csvPath = path;
                            console.log(`✅ CSV encontrado em: ${path}`);
                            break;
                        }
                    } catch (e) {
                        console.log(`❌ Falha ao carregar: ${path}`);
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('Não foi possível carregar o arquivo CSV');
                }
                
                const csvText = await response.text();
                console.log('CSV carregado, processando dados...');
                console.log(`Tamanho do CSV: ${csvText.length} caracteres`);
                
                const lines = csvText.split('\n');
                console.log(`Total de linhas no CSV: ${lines.length}`);
                
                if (lines.length < 100) {
                    throw new Error(`CSV muito pequeno: ${lines.length} linhas`);
                }
                
                allSchools = [];
                
                // Pular o cabeçalho (primeira linha)
                let processedCount = 0;
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        // Usar uma abordagem mais robusta para parsing CSV
                        const values = parseCSVLine(line);
                        
                        if (values.length >= 27) { // Verificar se tem colunas suficientes
                            const school = {
                                name: values[0] || '',
                                classification: values[1] || '',
                                directorate: values[5] || '',
                                municipality: values[7] || '',
                                idebFinal: parseFloat(values[10]) || 0,
                                idebHigh: parseFloat(values[12]) || 0,
                                students: parseInt(values[14]) || 0,
                                classes: parseInt(values[23]) || 0,
                                classrooms: parseInt(values[26]) || 0,
                                status: values[4] || '',
                                phone: values[8] || '',
                                email: values[9] || ''
                            };
                            
                            // Só adicionar se tem pelo menos nome e classificação
                            if (school.name && school.classification) {
                                allSchools.push(school);
                            }
                        }
                        
                        processedCount++;
                        if (processedCount % 1000 === 0) {
                            console.log(`Processadas ${processedCount} linhas...`);
                        }
                    }
                }
                
                console.log(`Escolas carregadas: ${allSchools.length}`);
                console.log('Primeiras 5 escolas:', allSchools.slice(0, 5));
                
                // Verificar se carregou dados suficientes
                if (allSchools.length < 100) {
                    throw new Error(`Poucos dados carregados: ${allSchools.length} escolas`);
                }
                
                filteredSchools = [...allSchools];
                populateDirectories();
                updateDashboard();
                setupEventListeners();
                
                loadingIndicator.style.display = 'none';
                console.log('✅ Dados carregados com sucesso!');
                
                // Atualizar status
                document.getElementById('dataStatus').textContent = '✅';
                document.getElementById('dataStatus').style.color = '#28a745';
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                console.log('Usando dados de fallback...');
                
                // Dados de fallback mais robustos
                allSchools = [
                    { name: "16 DE JULHO", classification: "PEI", directorate: "SANTO ANDRE", municipality: "SANTO ANDRE", idebFinal: 4.6, idebHigh: 5.1, students: 269, classes: 12, classrooms: 18, status: "SUCCESS" },
                    { name: "17 DE SETEMBRO", classification: "PEI", directorate: "MARILIA", municipality: "POMPEIA", idebFinal: 5.5, idebHigh: 0, students: 258, classes: 9, classrooms: 10, status: "SUCCESS" },
                    { name: "18 DE JUNHO", classification: "PEI", directorate: "SANTO ANASTACIO", municipality: "PRESIDENTE EPITACIO", idebFinal: 6.0, idebHigh: 4.2, students: 688, classes: 20, classrooms: 18, status: "SUCCESS" },
                    { name: "20 DE AGOSTO", classification: "EE", directorate: "SAO BERNARDO DO CAMPO", municipality: "SAO BERNARDO DO CAMPO", idebFinal: 5.6, idebHigh: 4.9, students: 592, classes: 15, classrooms: 10, status: "SUCCESS" },
                    { name: "21 DE ABRIL", classification: "PEI", directorate: "LINS", municipality: "LINS", idebFinal: 0, idebHigh: 5.0, students: 361, classes: 12, classrooms: 15, status: "SUCCESS" },
                    { name: "31 DE MARCO", classification: "EE", directorate: "CAMPINAS LESTE", municipality: "CAMPINAS", idebFinal: 3.5, idebHigh: 0, students: 616, classes: 25, classrooms: 16, status: "SUCCESS" },
                    { name: "9 DE JULHO", classification: "PEI", directorate: "TAQUARITINGA", municipality: "TAQUARITINGA", idebFinal: 7.4, idebHigh: 6.9, students: 691, classes: 21, classrooms: 23, status: "SUCCESS" },
                    { name: "ABDALLA MIGUEL", classification: "EE", directorate: "TAQUARITINGA", municipality: "TABATINGA", idebFinal: 5.1, idebHigh: 4.3, students: 653, classes: 23, classrooms: 14, status: "SUCCESS" },
                    { name: "ABDIEL LOPES MONTEIRO PROF", classification: "PEI", directorate: "APIAI", municipality: "RIBEIRAO BRANCO", idebFinal: 5.0, idebHigh: 3.9, students: 243, classes: 7, classrooms: 8, status: "SUCCESS" },
                    { name: "ABEL AUGUSTO FRAGATA", classification: "PEI", directorate: "MARILIA", municipality: "MARILIA", idebFinal: 0, idebHigh: 0, students: 259, classes: 10, classrooms: 10, status: "SUCCESS" },
                    { name: "ABEL DOS REIS", classification: "EE", directorate: "RIBEIRAO PRETO", municipality: "CASSIA DOS COQUEIROS", idebFinal: 0, idebHigh: 5.5, students: 89, classes: 5, classrooms: 5, status: "SUCCESS" },
                    { name: "ABELARDO CESAR DOUTOR", classification: "EE", directorate: "SAO JOAO DA BOA VISTA", municipality: "ESPIRITO SANTO DO PINHAL", idebFinal: 4.2, idebHigh: 0, students: 191, classes: 9, classrooms: 8, status: "SUCCESS" },
                    { name: "ABIGAIL DE AZEVEDO GRILLO PROFESSOR", classification: "PEI", directorate: "PIRACICABA", municipality: "PIRACICABA", idebFinal: 4.7, idebHigh: 3.8, students: 252, classes: 9, classrooms: 14, status: "SUCCESS" },
                    { name: "ABILIO ALVES MARQUES", classification: "PEI", directorate: "JABOTICABAL", municipality: "BEBEDOURO", idebFinal: 5.1, idebHigh: 3.9, students: 820, classes: 25, classrooms: 18, status: "SUCCESS" },
                    { name: "ABILIO FONTES PROF", classification: "PEI", directorate: "ITAPETININGA", municipality: "ITAPETININGA", idebFinal: 5.9, idebHigh: 0, students: 488, classes: 14, classrooms: 9, status: "SUCCESS" },
                    { name: "ABILIO MANOEL", classification: "PEI", directorate: "JABOTICABAL", municipality: "BEBEDOURO", idebFinal: 5.9, idebHigh: 4.6, students: 419, classes: 12, classrooms: 12, status: "SUCCESS" },
                    { name: "ABILIO RAPOSO FERRAZ JUNIOR", classification: "PEI", directorate: "AVARE", municipality: "ITAI", idebFinal: 4.6, idebHigh: 0, students: 790, classes: 24, classrooms: 13, status: "SUCCESS" },
                    { name: "ABRAHAO DE MORAES PROFESSOR", classification: "PEI", directorate: "ITAPECERICA DA SERRA", municipality: "ITAPECERICA DA SERRA", idebFinal: 5.2, idebHigh: 4.8, students: 512, classes: 14, classrooms: 8, status: "SUCCESS" },
                    { name: "ABRAHAO JACOB LAFER DOUTOR", classification: "PEI", directorate: "SAO VICENTE", municipality: "PRAIA GRANDE", idebFinal: 0, idebHigh: 4.7, students: 368, classes: 11, classrooms: 11, status: "SUCCESS" },
                    { name: "ABRANCHE JOSE PROF", classification: "EE", directorate: "ARACATUBA", municipality: "ARACATUBA", idebFinal: 5.8, idebHigh: 4.4, students: 931, classes: 24, classrooms: 10, status: "SUCCESS" }
                ];
                
                filteredSchools = [...allSchools];
                populateDirectories();
                updateDashboard();
                setupEventListeners();
                
                loadingIndicator.style.display = 'none';
                console.log('⚠️ Usando dados de fallback devido a erro no carregamento');
                
                // Atualizar status
                document.getElementById('dataStatus').textContent = '⚠️';
                document.getElementById('dataStatus').style.color = '#ffc107';
            }
        }

        // Função para fazer parsing robusto de CSV
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function populateDirectories() {
            const directorateFilter = document.getElementById('directorateFilter');
            const directories = [...new Set(allSchools.map(s => s.directorate).filter(d => d))].sort();
            
            directories.forEach(dir => {
                const option = document.createElement('option');
                option.value = dir;
                option.textContent = dir;
                directorateFilter.appendChild(option);
            });
        }

        function setupEventListeners() {
            // Filtros
            document.getElementById('directorateFilter').addEventListener('change', filterData);
            document.getElementById('classificationFilter').addEventListener('change', filterData);
            document.getElementById('idebMinFilter').addEventListener('input', filterData);
            document.getElementById('studentsMinFilter').addEventListener('input', filterData);

            // Botões de filtro rápido
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    applyQuickFilter(this.dataset.filter);
                });
            });

            // Busca na tabela
            document.getElementById('tableSearch').addEventListener('input', function() {
                filterTable(this.value);
            });
        }

        function filterData() {
            const directorate = document.getElementById('directorateFilter').value;
            const classification = document.getElementById('classificationFilter').value;
            const idebMin = parseFloat(document.getElementById('idebMinFilter').value) || 0;
            const studentsMin = parseInt(document.getElementById('studentsMinFilter').value) || 0;

            filteredSchools = allSchools.filter(school => {
                let match = true;

                if (directorate && school.directorate !== directorate) match = false;
                if (classification && school.classification !== classification) match = false;
                if (idebMin > 0 && school.idebFinal < idebMin) match = false;
                if (studentsMin > 0 && school.students < studentsMin) match = false;

                return match;
            });

            currentPage = 1;
            updateDashboard();
        }

        function applyQuickFilter(filter) {
            switch(filter) {
                case 'top-ideb':
                    filteredSchools = allSchools.filter(s => s.idebFinal > 6.0).sort((a, b) => b.idebFinal - a.idebFinal);
                    break;
                case 'large-schools':
                    filteredSchools = allSchools.filter(s => s.students >= 1000);
                    break;
                case 'pei-only':
                    filteredSchools = allSchools.filter(s => s.classification === 'PEI');
                    break;
                case 'ee-only':
                    filteredSchools = allSchools.filter(s => s.classification === 'EE');
                    break;
                case 'high-performance':
                    filteredSchools = allSchools.filter(s => s.idebFinal >= 6.0 && s.students >= 500);
                    break;
                default:
                    filteredSchools = [...allSchools];
            }
            
            currentPage = 1;
            updateDashboard();
        }

        function updateDashboard() {
            updateStats();
            updateCharts();
            updateTable();
            updatePagination();
        }

        function updateStats() {
            const avgIdeb = filteredSchools.reduce((sum, school) => sum + school.idebFinal, 0) / filteredSchools.length || 0;
            const maxIdeb = Math.max(...filteredSchools.map(s => s.idebFinal)) || 0;
            const totalStudents = filteredSchools.reduce((sum, school) => sum + school.students, 0);

            document.getElementById('totalSchools').textContent = filteredSchools.length.toLocaleString();
            document.getElementById('avgIdeb').textContent = avgIdeb.toFixed(1);
            document.getElementById('maxIdeb').textContent = maxIdeb.toFixed(1);
            document.getElementById('totalStudents').textContent = totalStudents.toLocaleString();
        }

        function updateCharts() {
            // Gráfico IDEB
            const idebRanges = {
                '0-2': 0, '2-4': 0, '4-6': 0, '6-8': 0, '8-10': 0
            };

            filteredSchools.forEach(school => {
                if (school.idebFinal >= 0 && school.idebFinal < 2) idebRanges['0-2']++;
                else if (school.idebFinal >= 2 && school.idebFinal < 4) idebRanges['2-4']++;
                else if (school.idebFinal >= 4 && school.idebFinal < 6) idebRanges['4-6']++;
                else if (school.idebFinal >= 6 && school.idebFinal < 8) idebRanges['6-8']++;
                else if (school.idebFinal >= 8) idebRanges['8-10']++;
            });

            if (charts.ideb) {
                charts.ideb.data.datasets[0].data = Object.values(idebRanges);
                charts.ideb.update();
            } else {
                charts.ideb = new Chart(document.getElementById('idebChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(idebRanges),
                        datasets: [{
                            label: 'Escolas',
                            data: Object.values(idebRanges),
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed + ' escolas';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#333', font: { size: 10 } }
                            },
                            x: {
                                ticks: { color: '#333', font: { size: 10 } }
                            }
                        }
                    }
                });
            }

            // Gráfico Classificação
            const classificationCount = filteredSchools.reduce((acc, school) => {
                acc[school.classification] = (acc[school.classification] || 0) + 1;
                return acc;
            }, {});

            if (charts.classification) {
                charts.classification.data.datasets[0].data = [
                    classificationCount.PEI || 0,
                    classificationCount.EE || 0
                ];
                charts.classification.update();
            } else {
                charts.classification = new Chart(document.getElementById('classificationChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['PEI', 'EE'],
                        datasets: [{
                            data: [classificationCount.PEI || 0, classificationCount.EE || 0],
                            backgroundColor: ['#667eea', '#764ba2'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#333', font: { size: 11 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + ' escolas';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageSchools = filteredSchools.slice(startIndex, endIndex);

            pageSchools.forEach(school => {
                const row = document.createElement('tr');
                const idebClass = school.idebFinal >= 6 ? 'ideb-high' : school.idebFinal >= 4 ? 'ideb-medium' : 'ideb-low';
                
                row.innerHTML = `
                    <td>${school.name}</td>
                    <td>${school.classification}</td>
                    <td>${school.directorate}</td>
                    <td>${school.municipality}</td>
                    <td class="${idebClass}">${school.idebFinal > 0 ? school.idebFinal.toFixed(1) : '-'}</td>
                    <td class="${idebClass}">${school.idebHigh > 0 ? school.idebHigh.toFixed(1) : '-'}</td>
                    <td>${school.students.toLocaleString()}</td>
                    <td>${school.classes}</td>
                    <td>${school.classrooms}</td>
                    <td><span style="color: #28a745;">${school.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredSchools.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            const paginationInfo = document.getElementById('paginationInfo');
            
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredSchools.length);
            
            paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${filteredSchools.length} escolas`;
            
            pagination.innerHTML = '';
            
            // Botão Anterior
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Anterior';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateTable();
                    updatePagination();
                }
            };
            pagination.appendChild(prevBtn);
            
            // Páginas
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    currentPage = i;
                    updateTable();
                    updatePagination();
                };
                pagination.appendChild(pageBtn);
            }
            
            // Botão Próximo
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Próximo';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTable();
                    updatePagination();
                }
            };
            pagination.appendChild(nextBtn);
        }

        function filterTable(searchTerm) {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            });
        }

        function exportChart(chartId) {
            const canvas = document.getElementById(chartId);
            const link = document.createElement('a');
            link.download = `${chartId}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        function exportData() {
            const csvContent = [
                ['Escola', 'Classificação', 'Diretoria', 'Município', 'IDEB Anos Finais', 'IDEB Ensino Médio', 'Total Alunos', 'Total Turmas', 'Salas de Aula', 'Status'],
                ...filteredSchools.map(school => [
                    school.name,
                    school.classification,
                    school.directorate,
                    school.municipality,
                    school.idebFinal > 0 ? school.idebFinal.toFixed(1) : '',
                    school.idebHigh > 0 ? school.idebHigh.toFixed(1) : '',
                    school.students,
                    school.classes,
                    school.classrooms,
                    school.status
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'escolas_filtradas.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Função para recarregar dados
        function reloadData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            setTimeout(() => {
                loadSchoolData();
                loadingIndicator.style.display = 'none';
            }, 100);
        }

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar status inicial
            document.getElementById('dataStatus').textContent = '⏳';
            document.getElementById('dataStatus').style.color = '#667eea';
            
            loadSchoolData();
        });
    </script>
</body>
</html> 